<div class="profile-container">
  <div class="profile-header">
    <!-- Emoji Avatar Selector -->
    <div class="profile-avatar">
      <div class="emoji-circle" (click)="toggleEmojiPicker($event)">
        {{ user?.profileEmoji || 'üòä' }}
      </div>
      <button type="button" class="edit-emoji-btn" (click)="toggleEmojiPicker($event)" title="Change emoji" aria-label="Change emoji">
        ‚úèÔ∏è
        <!-- ‚úé -->
      </button>

      <!-- Emoji Picker Modal -->
      <div #emojiPicker class="emoji-picker" *ngIf="showEmojiPicker" (click)="$event.stopPropagation()">
        <div class="emoji-grid">
          <div *ngFor="let emoji of availableEmojis" class="emoji-option" (click)="selectEmoji(emoji)"
            [class.selected]="user?.profileEmoji === emoji">
            {{ emoji }}
          </div>
        </div>
      </div>
      
    </div>

    <h1 class="profile-name">{{ user?.name || 'User' }}</h1>
    <p class="email">{{ user?.email }}</p>

    <!-- Feedback Messages -->
    <div *ngIf="success" class="alert alert-success">
      {{ success }}
    </div>
    <div *ngIf="error" class="alert alert-danger">
      {{ error }}
    </div>
  </div>

  <div class="profile-content">
    <!-- Personal Information Section -->
    <div class="profile-section">
      <h2>Personal Information</h2>
      <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" class="profile-form">
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" formControlName="name" placeholder="Enter your full name">
          <div *ngIf="profileForm.get('name')?.touched && profileForm.get('name')?.invalid" class="error-text">
            Name is required (min 2 chars)
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" formControlName="email" placeholder="Enter your email" [readOnly]="true">
        </div>

        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" formControlName="phone" placeholder="Enter your phone number">
          <div *ngIf="profileForm.get('phone')?.touched && profileForm.get('phone')?.invalid" class="error-text">
            Invalid phone number
          </div>
        </div>

        <div class="form-actions">
          <div class="button-container">
            <button type="submit" class="btn-save" [disabled]="!profileForm.valid || isSaving">
              <span *ngIf="!isSaving">Save Changes</span>
              <span *ngIf="isSaving" class="saving">Saving...</span>
            </button>
            <span *ngIf="saveSuccess" class="success-message">Changes saved successfully!</span>
          </div>
        </div>
      </form>
    </div>

    <!-- Account Settings Section -->
    <div class="profile-section">
      <h2>Account Settings</h2>
      <div class="settings-list">
        <div class="setting-item">
          <div class="setting-info">
            <h3>Change Password</h3>
            <p>Update your account password</p>
          </div>
          <button class="btn-change" (click)="openChangePassword()">Change</button>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h3>Order History</h3>
            <p>View your past orders and track current ones</p>
          </div>
          <button class="btn-view" (click)="loadOrders()">View Orders</button>
        </div>

        <!-- <div class="setting-item">
          <div class="setting-info">
            <h3>Address Book</h3>
            <p>Manage your shipping addresses</p>
          </div>
          <button class="btn-manage" (click)="openAddAddress()">Add Address</button>
        </div> -->
      </div>
    </div>

    <!-- Order History Section -->
    <div class="profile-section" *ngIf="orders.length > 0">
      <h2>Order History</h2>
      <div *ngIf="loadingOrders" class="loading">Loading orders...</div>
      <div class="orders-list" *ngIf="!loadingOrders">
        <div *ngFor="let order of orders" class="order-card">
          <div class="order-header">
            <div class="order-info">
              <h3>Order #{{ order.orderNumber }}</h3>
              <p class="order-date">{{ order.createdAt | date: 'medium' }}</p>
            </div>
            <span class="order-status" [ngClass]="getOrderStatusClass(order.orderStatus)">
              {{ order.orderStatus }}
            </span>
          </div>
          <div class="order-body">
            <p><strong>Total:</strong> {{ order.currency }} {{ order.totalAmount }}</p>
            <p><strong>Items:</strong> {{ order.items.length }}</p>
            <p *ngIf="order.trackingInfo"><strong>Tracking:</strong> {{ order.trackingInfo }}</p>
          </div>
          <div class="order-actions">
            <button class="btn-view-detail" [routerLink]="['/orders', order.id]">View Details</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Address Book Section -->
    <div class="profile-section">
      <h2>Address Book</h2>
      <div *ngIf="loadingAddresses" class="loading">Loading addresses...</div>
      <div class="addresses-list" *ngIf="!loadingAddresses">
        <div *ngFor="let address of addresses" class="address-card">
          <div class="address-header">
            <h3>
              {{ address.city }}, {{ address.country }}
              <span class="default-badge" *ngIf="address.isDefault">Default</span>
            </h3>
          </div>
          <div class="address-body">
            <p>{{ address.street }}</p>
            <p>{{ address.city }}, {{ address.state }} {{ address.pincode }}</p>
            <p>{{ address.country }}</p>
          </div>
          <div class="address-actions">
            <button class="btn-edit" (click)="editAddress(address)">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn-delete" (click)="deleteAddress(address.id)">
              <i class="fas fa-trash"></i> Delete
            </button>
            <button class="btn-set-default" *ngIf="!address.isDefault" (click)="setDefaultAddress(address.id)">
              <i class="fas fa-star"></i> Set as Default
            </button>
          </div>
        </div>

        <div class="address-card add-new" (click)="openAddAddress()">
          <div class="add-icon">
            Ôºã
          </div>
          <p>Add New Address</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal" [class.show]="showChangePasswordModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Change Password</h2>
      <button class="close-btn" (click)="closeChangePassword()">&times;</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="password-form">
        <div class="form-group">
          <label for="currentPassword" class="password-form-label">Current Password</label>
          <div class="input-wrapper">
            <input [type]="showCurrentPassword ? 'text' : 'password'" id="currentPassword"
              formControlName="currentPassword" placeholder="Enter current password">
            <span class="toggle-password" (click)="togglePasswordVisibility('current')">
              <i [class]="showCurrentPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </span>
          </div>
        </div>

        <div class="form-group">
          <label for="newPassword" class="password-form-label">New Password</label>
          <div class="input-wrapper">
            <input [type]="showNewPassword ? 'text' : 'password'" id="newPassword" formControlName="newPassword"
              placeholder="Enter new password">
            <span class="toggle-password" (click)="togglePasswordVisibility('new')">
              <i [class]="showNewPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </span>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword" class="password-form-label">Confirm New Password</label>
          <div class="input-wrapper">
            <input [type]="showConfirmPassword ? 'text' : 'password'" id="confirmPassword"
              formControlName="confirmPassword" placeholder="Confirm new password">
            <span class="toggle-password" (click)="togglePasswordVisibility('confirm')">
              <i [class]="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </span>
          </div>
          <div *ngIf="passwordForm.errors?.['mismatch'] && passwordForm.get('confirmPassword')?.touched"
            class="error-text">
            Passwords do not match
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="closeChangePassword()">Cancel</button>
          <button type="submit" class="btn-save" [disabled]="!passwordForm.valid || isChangingPassword">
            <span *ngIf="!isChangingPassword">Update Password</span>
            <span *ngIf="isChangingPassword" class="saving">Updating...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Address Modal -->
<div class="modal" [class.show]="showAddressModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>{{ isEditMode ? 'Edit Address' : 'Add New Address' }}</h2>
      <button class="close-btn" (click)="closeAddressModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="addressForm" (ngSubmit)="saveAddress()" class="address-form">
        <div class="form-group">
          <label for="street">Street Address</label>
          <input type="text" id="street" formControlName="street" placeholder="Enter street address">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" formControlName="city" placeholder="City">
          </div>

          <div class="form-group">
            <label for="state">State</label>
            <input type="text" id="state" formControlName="state" placeholder="State">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="country">Country</label>
            <input type="text" id="country" formControlName="country" placeholder="Country">
          </div>

          <div class="form-group">
            <label for="pincode">Pincode</label>
            <input type="text" id="pincode" formControlName="pincode" placeholder="Pincode">
          </div>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" formControlName="isDefault">
            Set as default address
          </label>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="closeAddressModal()">Cancel</button>
          <button type="submit" class="btn-save" [disabled]="!addressForm.valid">
            {{ isEditMode ? 'Update Address' : 'Add Address' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>